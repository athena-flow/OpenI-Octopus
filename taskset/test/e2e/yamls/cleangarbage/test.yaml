#两个Role,其中一个有４个副本，只要其中一个副本成功，该Role成功，其他副本会被主动清理掉
#最终任务终止时，State为Succeeded,被清理掉的副本的重试次数不应该是全部为２

apiVersion: octopus.openi.pcl.cn/v1alpha1
kind: TaskSet
metadata:
  name: cleangarbage
spec:
  retryPolicy:
    retry: false
    maxRetryCount: 1
  roles:
    - name: role1
      replicas: 1
      eventPolicy: 
        - event: RoleSucceeded
          action: TaskSetSucceeded
      completionPolicy:
        maxFailed: 1
        minSucceeded: 1
      retryPolicy:
        retry: false
        maxRetryCount: 1
      template:
        metadata:
          annotations:
            scheduling.k8s.io/group-name: e2e-1
        spec:
          schedulerName: kube-batch
          restartPolicy: Never
          containers:
            - name: worker
              image: busybox
              command: ["sh","-c","sleep 100;exit 0"]
    - name: role2
      replicas: 4
      eventPolicy: 
        - event: RoleSucceeded
          action: NoAction
      completionPolicy:
        maxFailed: 4
        minSucceeded: 1
      retryPolicy:
        retry: true
        maxRetryCount: 2
      template:
        metadata:
          annotations:
            scheduling.k8s.io/group-name: e2e-1
        spec:
          schedulerName: kube-batch
          restartPolicy: Never
          containers:
            - name: worker
              image: busybox
              command: ["sh","-c","echo -e \"if [ '${TASKROLE_REPLICA_INDEX}' == '0' ]\\nthen\\nsleep 10\\nexit 0\\nelse\\nsleep 1000\\nexit 0\\nfi\" >script.sh;chmod +x ./script.sh;./script.sh"]
--- 
apiVersion: scheduling.incubator.k8s.io/v1alpha1
kind: PodGroup
metadata:
  name: e2e-1
spec:
  minMember: 4
